{% extends "base.html" %}

{% block title %}Search{% endblock %}

{% block extra_head %}
<style>
    .search-container {
        max-width: 55%;
        margin: 2rem 0;
    }
    
    .search-input {
        width: 100%;
        padding: 0.75rem 1rem;
        font-size: 1.1rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-family: et-book, Palatino, "Palatino Linotype", "Palatino LT STD", "Book Antiqua", Georgia, serif;
        background-color: #fff;
    }
    
    .search-input:focus {
        outline: none;
        border-color: #666;
        box-shadow: 0 0 0 2px rgba(102, 102, 102, 0.1);
    }
    
    .autocomplete-list {
        position: absolute;
        background: white;
        border: 1px solid #ccc;
        border-top: none;
        border-radius: 0 0 4px 4px;
        max-height: 300px;
        overflow-y: auto;
        width: 100%;
        z-index: 9999;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        display: none;
    }
    
    .autocomplete-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .autocomplete-item:hover,
    .autocomplete-item.active {
        background: #f5f5f5;
    }
    
    .autocomplete-icon {
        width: 24px;
        height: 24px;
        flex-shrink: 0;
    }
    
    .autocomplete-title {
        flex: 1;
        font-weight: 500;
    }
    
    .search-input-wrapper {
        position: relative;
    }
    
    .search-results {
        margin-top: 2rem;
    }
    
    .search-result {
        padding: 1.5rem 0;
        border-bottom: 1px solid #eee;
        position: relative;
    }
    
    .search-result:last-child {
        border-bottom: none;
    }
    
    .search-result-header {
        position: relative;
        margin-bottom: 0.5rem;
    }
    
    .search-result-icon {
        width: 32px;
        height: 32px;
        position: absolute;
        left: -4rem;
        top: 0;
    }
    
    .search-result h3 {
        margin: 0;
        font-size: 1.3rem;
    }
    
    .search-result h3 a {
        color: #333;
        text-decoration: none;
        background: none;
        text-shadow: none;
    }
    
    .search-result h3 a:hover {
        color: #666;
    }
    
    .search-result-meta {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }
    
    .search-result-type {
        display: inline-block;
        background: #f0f0f0;
        padding: 0.2rem 0.5rem;
        border-radius: 3px;
        font-size: 0.8rem;
        margin-right: 0.5rem;
    }
    
    .search-result-date,
    .search-result-matches {
        color: #888;
        font-size: 0.8rem;
        margin-left: 0.5rem;
    }
    
    .search-result-snippet {
        color: #555;
        font-size: 0.9rem;
        line-height: 1.4;
        margin-top: 0.5rem;
    }
    
    .search-result-snippet mark {
        background: #fff3cd;
        padding: 0.1rem 0.2rem;
        border-radius: 2px;
        font-weight: 500;
    }
    
    .loading {
        text-align: center;
        color: #666;
        font-style: italic;
        padding: 2rem 0;
    }
    
    .no-results {
        text-align: center;
        color: #666;
        padding: 2rem 0;
    }
    
    @media (max-width: 1400px) {
        .search-container {
            max-width: 60%;
        }
    }
    
    @media (max-width: 1200px) {
        .search-container {
            max-width: 70%;
        }
    }
    
    @media (max-width: 760px) {
        .search-container {
            max-width: 100%;
        }
        
        .autocomplete-list {
            font-size: 0.9rem;
        }
        
        .autocomplete-item {
            padding: 0.6rem 0.8rem;
        }
        
        .autocomplete-icon {
            width: 20px;
            height: 20px;
        }
        
        .search-result-icon {
            width: 28px;
            height: 28px;
            left: -3rem;
        }
    }
    
    @media (prefers-color-scheme: dark) {
        .search-input {
            background-color: #1a1a1a;
            color: #ccc;
            border-color: #333;
        }
        
        .search-input:focus {
            border-color: #666;
            box-shadow: 0 0 0 2px rgba(102, 102, 102, 0.2);
        }
        
        .autocomplete-list {
            background: #1a1a1a !important;
            border-color: #333;
        }
        
        .autocomplete-item {
            border-bottom-color: #2a2a2a;
        }
        
        .autocomplete-item:hover,
        .autocomplete-item.active {
            background: #2a2a2a;
        }
        
        .autocomplete-title {
            color: #ccc;
        }
        
        .search-result {
            border-bottom-color: #2a2a2a;
        }
        
        .search-result h3 a {
            color: #ccc;
        }
        
        .search-result h3 a:hover {
            color: #fff;
        }
        
        .search-result-type {
            background: #2a2a2a;
            color: #ccc;
        }
        
        .search-result-snippet {
            color: #aaa;
        }
        
        .search-result-snippet mark {
            background: #3d3d1a;
            color: #fbbf24;
        }
    }
</style>
{% endblock %}

{% block content %}
<h1>Search</h1>

<div class="search-container">
    <div class="search-input-wrapper">
        <input type="text" class="search-input" id="search-input" placeholder="Search essays, AI writings, and more..." autocomplete="off">
        <div id="autocomplete-list" class="autocomplete-list"></div>
    </div>
    
    <div id="search-results" class="search-results" style="display: none;">
        <div id="loading" class="loading" style="display: none;">
            Searching...
        </div>
        <div id="results-container"></div>
        <div id="no-results" class="no-results" style="display: none;">
            No results found. Try different keywords or browse the <a href="/directory">directory</a>.
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    const loading = document.getElementById('loading');
    const resultsContainer = document.getElementById('results-container');
    const noResults = document.getElementById('no-results');
    const autocompleteList = document.getElementById('autocomplete-list');
    let searchTimeout;
    let autocompleteTimeout;
    let allPosts = [];
    let currentFocus = -1;
    
    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Helper function to highlight search terms
    function highlightText(text, query) {
        if (!text || !query) return escapeHtml(text);
        
        const escapedText = escapeHtml(text);
        const terms = query.toLowerCase().split(/\s+/).filter(t => t.length > 0);
        
        let highlighted = escapedText;
        terms.forEach(term => {
            const regex = new RegExp(`(${term})`, 'gi');
            highlighted = highlighted.replace(regex, '<mark>$1</mark>');
        });
        
        return highlighted;
    }
    
    // Fetch all posts for autocomplete
    fetch('/api/blog')
        .then(response => response.json())
        .then(data => {
            allPosts = data.posts || [];
        })
        .catch(error => console.error('Failed to load posts for autocomplete:', error));
    
    // Get search query from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const initialQuery = urlParams.get('q');
    if (initialQuery) {
        searchInput.value = initialQuery;
        performSearch(initialQuery);
    }
    
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        // Clear previous timeouts
        clearTimeout(searchTimeout);
        clearTimeout(autocompleteTimeout);
        
        if (query.length === 0) {
            searchResults.style.display = 'none';
            autocompleteList.style.display = 'none';
            return;
        }
        
        // Show autocomplete immediately
        autocompleteTimeout = setTimeout(() => {
            showAutocomplete(query);
        }, 150);
        
        // Show full search results after delay
        searchTimeout = setTimeout(() => {
            performSearch(query);
        }, 300);
    });
    
    // Keyboard navigation
    searchInput.addEventListener('keydown', function(e) {
        const items = autocompleteList.getElementsByClassName('autocomplete-item');
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            currentFocus++;
            addActive(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            currentFocus--;
            addActive(items);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (currentFocus > -1 && items[currentFocus]) {
                items[currentFocus].click();
            } else if (this.value.trim()) {
                performSearch(this.value.trim());
                autocompleteList.style.display = 'none';
            }
        } else if (e.key === 'Escape') {
            autocompleteList.style.display = 'none';
            currentFocus = -1;
        }
    });
    
    // Close autocomplete when clicking outside
    document.addEventListener('click', function(e) {
        if (e.target !== searchInput) {
            autocompleteList.style.display = 'none';
            currentFocus = -1;
        }
    });
    
    function addActive(items) {
        if (!items || items.length === 0) return;
        removeActive(items);
        
        if (currentFocus >= items.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = items.length - 1;
        
        items[currentFocus].classList.add('active');
        items[currentFocus].scrollIntoView({ block: 'nearest' });
    }
    
    function removeActive(items) {
        for (let i = 0; i < items.length; i++) {
            items[i].classList.remove('active');
        }
    }
    
    function showAutocomplete(query) {
        if (!allPosts || allPosts.length === 0) return;
        
        const queryLower = query.toLowerCase();
        const matches = allPosts.filter(post => 
            post.title.toLowerCase().includes(queryLower)
        ).slice(0, 5);
        
        if (matches.length === 0) {
            autocompleteList.style.display = 'none';
            return;
        }
        
        autocompleteList.innerHTML = '';
        currentFocus = -1;
        
        matches.forEach(post => {
            const item = document.createElement('div');
            item.className = 'autocomplete-item';
            
            const icon = post.unique_icon ? 
                `<img src="${post.unique_icon}" class="autocomplete-icon" alt="">` : 
                '<span class="autocomplete-icon">ðŸ“„</span>';
            
            item.innerHTML = `
                ${icon}
                <span class="autocomplete-title">${highlightText(post.title, query)}</span>
            `;
            
            item.addEventListener('click', function() {
                window.location.href = post.url;
            });
            
            autocompleteList.appendChild(item);
        });
        
        autocompleteList.style.display = 'block';
    }
    
    function performSearch(query) {
        if (!query) return;
        
        searchResults.style.display = 'block';
        loading.style.display = 'block';
        resultsContainer.innerHTML = '';
        noResults.style.display = 'none';
        
        // Update URL without reloading
        const newUrl = new URL(window.location);
        newUrl.searchParams.set('q', query);
        window.history.replaceState({}, '', newUrl);
        
        fetch(`/api/search?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                
                if (data.error) {
                    resultsContainer.innerHTML = `<div class="no-results">${data.error}</div>`;
                    return;
                }
                
                if (!data.results || data.results.length === 0) {
                    noResults.style.display = 'block';
                    return;
                }
                
                data.results.forEach(result => {
                    const resultElement = document.createElement('div');
                    resultElement.className = 'search-result';
                    
                    const iconHtml = result.unique_icon ? 
                        `<img src="${result.unique_icon}" class="search-result-icon" alt="">` : '';
                    
                    const snippetHtml = result.snippet ? 
                        `<div class="search-result-snippet">${highlightText(result.snippet, query)}</div>` : '';
                    
                    const dateHtml = result.date ? 
                        `<span class="search-result-date">${result.date}</span>` : '';
                    
                    const matchesHtml = result.matches && result.matches.length > 0 ? 
                        `<span class="search-result-matches">Found in: ${result.matches.join(', ')}</span>` : '';
                    
                    resultElement.innerHTML = `
                        <div class="search-result-header">
                            ${iconHtml}
                            <h3><a href="${result.url}">${highlightText(result.title, query)}</a></h3>
                        </div>
                        <div class="search-result-meta">
                            <span class="search-result-type">ðŸ“„ Essay</span>
                            ${dateHtml}
                            ${matchesHtml}
                        </div>
                        ${snippetHtml}
                    `;
                    
                    resultsContainer.appendChild(resultElement);
                });
            })
            .catch(error => {
                loading.style.display = 'none';
                resultsContainer.innerHTML = '<div class="no-results">Search error occurred. Please try again.</div>';
            });
    }
});
</script>
{% endblock %}