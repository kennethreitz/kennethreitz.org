{% extends "base.html" %}

{% block title %}Search{% endblock %}

{% block extra_head %}
<style>
    .search-container {
        max-width: 55%;
        margin: 2rem 0;
    }
    
    .search-input {
        width: 100%;
        padding: 0.75rem 1rem;
        font-size: 1.1rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-family: et-book, Palatino, "Palatino Linotype", "Palatino LT STD", "Book Antiqua", Georgia, serif;
        background-color: #fff;
    }
    
    .search-input:focus {
        outline: none;
        border-color: #666;
        box-shadow: 0 0 0 2px rgba(102, 102, 102, 0.1);
    }
    
    .search-results {
        margin-top: 2rem;
    }
    
    .search-result {
        padding: 1.5rem 0;
        border-bottom: 1px solid #eee;
    }
    
    .search-result:last-child {
        border-bottom: none;
    }
    
    .search-result-header {
        position: relative;
        margin-bottom: 0.5rem;
    }
    
    .search-result-icon {
        width: 32px;
        height: 32px;
        position: absolute;
        left: -4rem;
        top: 0;
    }
    
    .search-result h3 {
        margin: 0;
        font-size: 1.3rem;
    }
    
    .search-result h3 a {
        color: #333;
        text-decoration: none;
        background: none;
        text-shadow: none;
    }
    
    .search-result h3 a:hover {
        color: #666;
    }
    
    .search-result-meta {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }
    
    .search-result-type {
        display: inline-block;
        background: #f0f0f0;
        padding: 0.2rem 0.5rem;
        border-radius: 3px;
        font-size: 0.8rem;
        margin-right: 0.5rem;
    }
    
    .search-result-date,
    .search-result-matches {
        color: #888;
        font-size: 0.8rem;
        margin-left: 0.5rem;
    }
    
    .search-result-snippet {
        color: #555;
        font-size: 0.9rem;
        line-height: 1.4;
        margin-top: 0.5rem;
    }
    
    .search-result-snippet mark {
        background: #fff3cd;
        padding: 0.1rem 0.2rem;
        border-radius: 2px;
        font-weight: 500;
    }
    
    .loading {
        text-align: center;
        color: #666;
        font-style: italic;
        padding: 2rem 0;
    }
    
    .no-results {
        text-align: center;
        color: #666;
        padding: 2rem 0;
    }
    
    @media (max-width: 1400px) {
        .search-container {
            max-width: 60%;
        }
    }
    
    @media (max-width: 1200px) {
        .search-container {
            max-width: 70%;
        }
    }
    
    @media (max-width: 760px) {
        .search-container {
            max-width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<h1>Search</h1>

<div class="search-container">
    <input type="text" class="search-input" id="search-input" placeholder="Search essays, AI writings, and more..." autocomplete="off">
    
    <div id="search-results" class="search-results" style="display: none;">
        <div id="loading" class="loading" style="display: none;">
            Searching...
        </div>
        <div id="results-container"></div>
        <div id="no-results" class="no-results" style="display: none;">
            No results found. Try different keywords or browse the <a href="/directory">directory</a>.
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    const loading = document.getElementById('loading');
    const resultsContainer = document.getElementById('results-container');
    const noResults = document.getElementById('no-results');
    let searchTimeout;
    
    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Get search query from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const initialQuery = urlParams.get('q');
    if (initialQuery) {
        searchInput.value = initialQuery;
        performSearch(initialQuery);
    }
    
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        // Clear previous timeout
        clearTimeout(searchTimeout);
        
        if (query.length === 0) {
            searchResults.style.display = 'none';
            return;
        }
        
        // Show loading after short delay to avoid flickering
        searchTimeout = setTimeout(() => {
            performSearch(query);
        }, 300);
    });
    
    function performSearch(query) {
        if (!query) return;
        
        searchResults.style.display = 'block';
        loading.style.display = 'block';
        resultsContainer.innerHTML = '';
        noResults.style.display = 'none';
        
        // Update URL without reloading
        const newUrl = new URL(window.location);
        newUrl.searchParams.set('q', query);
        window.history.replaceState({}, '', newUrl);
        
        fetch(`/api/search?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                
                if (data.error) {
                    resultsContainer.innerHTML = `<div class="no-results">${data.error}</div>`;
                    return;
                }
                
                if (!data.results || data.results.length === 0) {
                    noResults.style.display = 'block';
                    return;
                }
                
                data.results.forEach(result => {
                    const resultElement = document.createElement('div');
                    resultElement.className = 'search-result';
                    
                    const typeIcon = 'ðŸ“„'; // All results are essays/posts
                    
                    const snippetHtml = result.snippet ? 
                        `<div class="search-result-snippet">${escapeHtml(result.snippet)}</div>` : '';
                    
                    const dateHtml = result.date ? 
                        `<span class="search-result-date">${result.date}</span>` : '';
                    
                    const matchesHtml = result.matches && result.matches.length > 0 ? 
                        `<span class="search-result-matches">Found in: ${result.matches.join(', ')}</span>` : '';
                    
                    resultElement.innerHTML = `
                        <div class="search-result-header">
                            <h3><a href="${result.url}">${escapeHtml(result.title)}</a></h3>
                        </div>
                        <div class="search-result-meta">
                            <span class="search-result-type">${typeIcon} Essay</span>
                            ${dateHtml}
                            ${matchesHtml}
                        </div>
                        ${snippetHtml}
                    `;
                    
                    resultsContainer.appendChild(resultElement);
                });
            })
            .catch(error => {
                loading.style.display = 'none';
                resultsContainer.innerHTML = '<div class="no-results">Search error occurred. Please try again.</div>';
            });
    }
});
</script>
{% endblock %}